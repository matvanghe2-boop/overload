<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#00D4FF"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="OVERLOAD"/>
  <title>OVERLOAD</title>

  <!-- PWA Manifest inline -->
  <script>
    const manifestData = {
      name: "OVERLOAD â€” Tracker Musculation",
      short_name: "OVERLOAD",
      description: "Suivi de sÃ©ances de musculation",
      theme_color: "#00D4FF",
      background_color: "#09090b",
      display: "standalone",
      orientation: "portrait",
      start_url: "./overload.html",
      icons: [
        { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%2309090b'/%3E%3Crect x='20' y='88' width='152' height='16' rx='4' fill='%2300D4FF'/%3E%3Crect x='16' y='72' width='16' height='48' rx='4' fill='%2300D4FF'/%3E%3Crect x='8' y='80' width='12' height='32' rx='3' fill='%2300D4FF'/%3E%3Crect x='160' y='72' width='16' height='48' rx='4' fill='%2300D4FF'/%3E%3Crect x='172' y='80' width='12' height='32' rx='3' fill='%2300D4FF'/%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifestData)], {type:'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest'; link.href = manifestURL;
    document.head.appendChild(link);
  </script>

  <!-- React + Babel via CDN -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --cyan: #00D4FF;
      --cyan-dim: rgba(0,212,255,0.15);
      --cyan-glow: 0 0 20px rgba(0,212,255,0.4);
      --green: #00FF9D;
      --bg: #09090b;
      --bg2: #111116;
      --surface: #18181b;
      --surface2: #27272a;
      --border: #2a2a30;
      --text: #fafafa;
      --text2: #a1a1aa;
      --text3: #52525b;
      --danger: #ef4444;
      --warn: #fbbf24;
      --radius: 16px;
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; }
    #root { height: 100%; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 0; height: 0; }

    /* Animations */
    @keyframes fillBar {
      0%   { width: 0%; }
      100% { width: 50%; }
    }
    @keyframes blinkR {
      0%,49%,100% { opacity:1; }
      50%,99%     { opacity:0.2; }
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity:0; }
      to   { transform: translateY(0); opacity:1; }
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(0,212,255,0.4); }
      50%      { box-shadow: 0 0 0 8px rgba(0,212,255,0); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .fade-in { animation: fadeIn 0.3s ease forwards; }
    .slide-up { animation: slideUp 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards; }

    /* App shell */
    .app {
      max-width: 430px;
      margin: 0 auto;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      position: relative;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 80px;
      -webkit-overflow-scrolling: touch;
    }

    /* Nav bar */
    .nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: rgba(17,17,22,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 4px 8px;
      gap: 3px;
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-btn .nav-icon { font-size: 20px; transition: transform 0.2s; }
    .nav-btn .nav-label { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; color: var(--text3); transition: color 0.2s; }
    .nav-btn.active .nav-label { color: var(--cyan); }
    .nav-btn.active .nav-icon { transform: scale(1.15); }
    .nav-btn.active.session-btn { background: linear-gradient(to top, rgba(0,212,255,0.1), transparent); }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }

    .card-sm {
      background: var(--surface2);
      border-radius: 12px;
      padding: 14px;
    }

    /* Buttons */
    .btn-primary {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      background: var(--cyan);
      color: #000;
      font-weight: 800;
      font-size: 16px;
      border: none;
      cursor: pointer;
      letter-spacing: 0.5px;
      transition: all 0.15s;
      box-shadow: 0 4px 20px rgba(0,212,255,0.3);
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(0,212,255,0.2); }

    .btn-secondary {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text2);
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-secondary:active { background: var(--surface); }

    .btn-ghost {
      background: none;
      border: 1px dashed var(--border);
      color: var(--text3);
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: all 0.15s;
    }
    .btn-ghost:hover { border-color: var(--cyan); color: var(--cyan); }

    /* Tags/Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }

    .pill-active { background: var(--cyan); color: #000; }
    .pill-inactive { background: var(--surface2); color: var(--text2); }
    .pill-ghost { background: var(--surface2); color: var(--text3); }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 200;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 16px;
      animation: fadeIn 0.2s ease;
    }

    .modal-sheet {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px 24px 16px 16px;
      width: 100%;
      max-width: 430px;
      max-height: 85dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.34,1.2,0.64,1) forwards;
    }

    .modal-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto 0;
      flex-shrink: 0;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal-title { font-size: 17px; font-weight: 800; }
    .modal-close {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--surface2);
      border: none;
      color: var(--text2);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      overflow-y: auto;
      padding: 16px 20px;
      flex: 1;
    }

    /* Cat tabs */
    .cat-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-bottom: 14px;
    }

    /* Input */
    .input {
      width: 100%;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
    }
    .input:focus { border-color: var(--cyan); }

    select.input { cursor: pointer; }

    /* Label */
    .label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 6px;
      display: block;
    }

    /* Logo bar animation */
    .logo-bar-fill {
      animation: fillBar 1.4s ease forwards;
      background: var(--cyan);
      box-shadow: 0 0 14px var(--cyan), 0 0 28px rgba(0,212,255,0.4);
      border-radius: 3px;
      height: 100%;
      position: absolute;
      left: 0; top: 0;
    }
    .blink-r { animation: blinkR 1s ease 1.5s infinite; }

    /* Scroll picker */
    .scroll-picker {
      position: relative;
      height: 180px;
      overflow: hidden;
      border-radius: 14px;
      background: var(--surface2);
      width: 110px;
    }

    .scroll-picker-fade {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 10;
      background: linear-gradient(to bottom, var(--surface2) 0%, transparent 35%, transparent 65%, var(--surface2) 100%);
    }

    .scroll-picker-line {
      position: absolute;
      left: 0; right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 44px;
      pointer-events: none;
      z-index: 10;
      border-top: 1px solid rgba(0,212,255,0.3);
      border-bottom: 1px solid rgba(0,212,255,0.3);
    }

    .scroll-picker-inner {
      height: 100%;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
    }

    .scroll-picker-item {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 800;
      scroll-snap-align: center;
      cursor: pointer;
      transition: color 0.15s;
    }

    /* Bubble selector */
    .bubble-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .bubble {
      width: 42px; height: 42px;
      border-radius: 50%;
      border: none;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }

    .bubble-active {
      background: var(--cyan);
      color: #000;
      box-shadow: 0 0 14px rgba(0,212,255,0.5);
      transform: scale(1.1);
    }

    .bubble-inactive { background: var(--surface2); color: var(--text2); }

    /* Set row */
    .set-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--surface2);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .set-num {
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 1px;
      min-width: 28px;
    }

    .set-info {
      flex: 1;
      font-weight: 700;
      font-size: 15px;
    }

    .set-tonnage {
      font-size: 13px;
      font-weight: 700;
      color: var(--cyan);
    }

    .set-del {
      background: none;
      border: none;
      color: var(--text3);
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      -webkit-tap-highlight-color: transparent;
    }

    /* Progress bars */
    .prog-bar-track {
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
    }

    .prog-bar-fill {
      height: 100%;
      background: var(--cyan);
      border-radius: 2px;
      transition: width 0.6s ease;
    }

    /* Stats grid */
    .stats-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stats-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    /* Chart bars */
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 120px;
    }

    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      height: 100%;
      justify-content: flex-end;
    }

    .bar-rect {
      width: 100%;
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
      min-height: 3px;
    }

    .bar-label {
      font-size: 8px;
      color: var(--text3);
      font-weight: 600;
      text-align: center;
    }

    /* Radar chart */
    .radar-wrap { padding: 8px 0; }

    /* Measurement grid */
    .meas-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .meas-btn {
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }

    .meas-btn:active { background: var(--surface); border-color: var(--cyan); }
    .meas-val { font-size: 20px; font-weight: 800; color: var(--text); margin-top: 2px; }

    /* Section title */
    .section-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 10px;
    }

    /* Separator */
    .sep {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 16px 0;
    }

    .sep-line { flex: 1; height: 1px; background: var(--border); }
    .sep-text { font-size: 12px; color: var(--text3); }

    /* Last session badge */
    .last-set-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(0,212,255,0.08);
      border: 1px solid rgba(0,212,255,0.2);
      font-size: 12px;
      font-weight: 600;
      color: var(--cyan);
    }

    /* RPE scale */
    .rpe-grid {
      display: grid;
      grid-template-columns: repeat(5,1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    /* Exercise list item */
    .ex-item {
      display: flex;
      align-items: center;
      padding: 13px 14px;
      background: var(--surface2);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1.5px solid transparent;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }

    .ex-item:active { border-color: var(--cyan); background: var(--surface); }

    /* Done screen */
    .done-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70dvh;
      text-align: center;
      gap: 16px;
      padding: 32px 24px;
    }

    .trophy { font-size: 72px; animation: pulse 2s ease infinite; }

    /* Chip row for exercises in session */
    .ex-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    /* Validate btn pulse */
    .validate-btn {
      animation: pulse 2.5s ease infinite;
    }

    /* Scrollbar hide */
    .no-scroll::-webkit-scrollbar { display: none; }
    .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* RPE colors */
    .rpe-easy  { background: rgba(34,197,94,0.2);  color: #4ade80; }
    .rpe-med   { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .rpe-hard  { background: rgba(239,68,68,0.2);  color: #f87171; }

    /* Loading */
    .loader {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Page padding */
    .page { padding: 16px; }
    .page-top { padding-top: 20px; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CYAN = "#00D4FF";

const EXERCISES = {
  "Poitrine":  ["DÃ©veloppÃ© couchÃ© barre","DÃ©veloppÃ© couchÃ© haltÃ¨res","DÃ©veloppÃ© inclinÃ© barre","DÃ©veloppÃ© inclinÃ© haltÃ¨res","Ã‰cartÃ© haltÃ¨res","Ã‰cartÃ© poulie","Pompes lestÃ©es","Dips"],
  "Dos":       ["Tractions","Rowing barre","Rowing haltÃ¨re","Tirage poitrine","Tirage nuque","Rowing cÃ¢ble","SoulevÃ© de terre","Shrug barre"],
  "Ã‰paules":   ["DÃ©veloppÃ© militaire barre","DÃ©veloppÃ© militaire haltÃ¨res","Ã‰lÃ©vations latÃ©rales","Oiseau haltÃ¨res","Face pull","Ã‰lÃ©vations frontales","Arnold press"],
  "Biceps":    ["Curl barre","Curl haltÃ¨res","Curl marteau","Curl inclinÃ©","Curl cÃ¢ble","Curl pupitre"],
  "Triceps":   ["Dips triceps","Extension nuque barre","Extension poulie haute","Kickback haltÃ¨re","Close grip bench","Overhead cÃ¢ble"],
  "Jambes":    ["Squat barre","Presse Ã  cuisses","Fentes haltÃ¨res","Leg extension","Leg curl","SoulevÃ© de terre jambes tendues","Hip thrust","Mollets debout","Mollets assis"],
  "Abdos":     ["Crunch","Planche","RelevÃ© de jambes","Russian twist","Ab wheel","Cable crunch"],
};

const WEIGHT_OPTIONS = [0,2.5,5,7.5,10,12.5,15,17.5,20,22.5,25,27.5,30,32.5,35,37.5,40,42.5,45,47.5,50,55,60,65,70,75,80,85,90,95,100,110,120,130,140,150,160,180,200];
const REPS_OPTIONS   = Array.from({length:20},(_,i)=>i+1);
const BODY_WEIGHT    = Array.from({length:141},(_,i)=>+(40+i*0.5).toFixed(1));
const MEASURE_OPTS   = Array.from({length:121},(_,i)=>20+i);
const RPE_OPTIONS    = [1,2,3,4,5,6,7,8,9,10];

const MEASUREMENTS   = [
  {key:"chest",label:"Poitrine"},{key:"shoulders",label:"Ã‰paules"},
  {key:"waist",label:"Taille"},{key:"hips",label:"Hanches"},
  {key:"bicepL",label:"Biceps G."},{key:"bicepR",label:"Biceps D."},
  {key:"thigh",label:"Cuisse"},{key:"calf",label:"Mollet"},
];

const RADAR_KEYS   = ["chest","shoulders","waist","hips","bicepL","thigh","calf"];
const RADAR_LABELS = ["Poitrine","Ã‰paules","Taille","Hanches","Biceps","Cuisse","Mollet"];

const DEFAULT_TEMPLATES = [
  {id:1,name:"Push",exercises:[{name:"DÃ©veloppÃ© couchÃ© barre",cat:"Poitrine"},{name:"DÃ©veloppÃ© inclinÃ© haltÃ¨res",cat:"Poitrine"},{name:"DÃ©veloppÃ© militaire barre",cat:"Ã‰paules"},{name:"Ã‰lÃ©vations latÃ©rales",cat:"Ã‰paules"},{name:"Extension poulie haute",cat:"Triceps"}]},
  {id:2,name:"Pull",exercises:[{name:"Tractions",cat:"Dos"},{name:"Rowing barre",cat:"Dos"},{name:"Tirage poitrine",cat:"Dos"},{name:"Curl barre",cat:"Biceps"},{name:"Curl haltÃ¨res",cat:"Biceps"}]},
  {id:3,name:"Legs",exercises:[{name:"Squat barre",cat:"Jambes"},{name:"Presse Ã  cuisses",cat:"Jambes"},{name:"Leg curl",cat:"Jambes"},{name:"Fentes haltÃ¨res",cat:"Jambes"},{name:"Mollets debout",cat:"Jambes"}]},
];

// â”€â”€ localStorage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ localStorage (cache local rapide) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lsGet = (key, fallback) => { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } };
const lsSet = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} };

// â”€â”€ GitHub Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GH = {
  owner : "matvanghe2-boop",
  repo  : "overload",
  file  : "data.json",
  token : "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",
  get url() { return `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${this.file}`; },
  get headers() {
    return {
      "Authorization": `token ${this.token}`,
      "Accept": "application/vnd.github.v3+json",
      "Content-Type": "application/json"
    };
  }
};

// Lire depuis GitHub â†’ retourne {data, sha} ou null
async function ghRead() {
  try {
    const res = await fetch(GH.url, { headers: GH.headers });
    if (!res.ok) return null;
    const json = await res.json();
    const data = JSON.parse(atob(json.content.replace(/
/g, "")));
    return { data, sha: json.sha };
  } catch { return null; }
}

// Ã‰crire vers GitHub
async function ghWrite(data, sha) {
  try {
    const body = {
      message: `sync ${new Date().toISOString()}`,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
      sha
    };
    const res = await fetch(GH.url, {
      method: "PUT",
      headers: GH.headers,
      body: JSON.stringify(body)
    });
    if (!res.ok) return false;
    const json = await res.json();
    // Mettre Ã  jour le SHA en cache pour le prochain write
    lsSet("ol:gh_sha", json.content.sha);
    return true;
  } catch { return false; }
}

// SHA courant (Ã©vite de refetch pour chaque write)
async function getOrFetchSha() {
  const cached = lsGet("ol:gh_sha", null);
  if (cached) return cached;
  const r = await ghRead();
  if (r) { lsSet("ol:gh_sha", r.sha); return r.sha; }
  return null;
}

// Sauvegarder tout vers GitHub (debounced 2s)
let _syncTimer = null;
function scheduleSyncToGH(allData) {
  if (_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(async () => {
    lsSet("ol:syncStatus", "syncing");
    window.dispatchEvent(new Event("ol:syncStatusChange"));
    const sha = await getOrFetchSha();
    if (!sha) {
      lsSet("ol:syncStatus", "error");
      window.dispatchEvent(new Event("ol:syncStatusChange"));
      return;
    }
    const ok = await ghWrite(allData, sha);
    lsSet("ol:syncStatus", ok ? "ok" : "error");
    if (ok) lsSet("ol:lastSync", new Date().toISOString());
    window.dispatchEvent(new Event("ol:syncStatusChange"));
  }, 2000);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt       = d => new Date(d).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});
const fmtShort  = d => new Date(d).toLocaleDateString("fr-FR",{day:"2-digit",month:"short"});
const calcTon   = sets => sets.reduce((s,st) => s + st.weight * st.reps, 0);
const weekStart = () => { const d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()-((d.getDay()||7)-1)); return d.getTime(); };
const monthStart= () => { const d=new Date(); d.setHours(0,0,0,0); d.setDate(1); return d.getTime(); };

function getLastSession(sessions, name) {
  for (let i=sessions.length-1; i>=0; i--) {
    const ex = sessions[i].exercises?.find(e=>e.name===name);
    if (ex?.sets?.length) return ex.sets;
  }
  return null;
}
function getLastWeight(sessions, name) {
  const sets = getLastSession(sessions, name);
  return sets?.length ? sets[sets.length-1].weight : null;
}

// â”€â”€ DumbbellLogo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DumbbellLogo({size=40}) {
  const s = size/40;
  return (
    <div style={{display:"flex",alignItems:"center",transform:`scale(${s})`,transformOrigin:"right center",flexShrink:0}}>
      <div style={{width:7,height:28,background:CYAN,borderRadius:2,boxShadow:`0 0 8px ${CYAN}`,marginRight:-1}}/>
      <div style={{width:12,height:46,background:CYAN,borderRadius:2,boxShadow:`0 0 10px ${CYAN}`,marginRight:-1}}/>
      <div style={{position:"relative",width:80,height:14,background:"#27272a",borderRadius:3,overflow:"hidden"}}>
        <div className="logo-bar-fill" style={{width:"50%"}}/>
      </div>
      <div className="blink-r" style={{width:12,height:46,background:CYAN,borderRadius:2,boxShadow:`0 0 10px ${CYAN}`,marginLeft:-1}}/>
      <div className="blink-r" style={{width:7,height:28,background:CYAN,borderRadius:2,boxShadow:`0 0 8px ${CYAN}`,marginLeft:-1}}/>
    </div>
  );
}

// â”€â”€ ScrollPicker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ScrollPicker({options, value, onChange, unit=""}) {
  const ref = useRef();
  const idx = options.indexOf(value);

  useEffect(() => {
    if (ref.current) {
      ref.current.scrollTop = Math.max(0, (idx - 2)) * 44;
    }
  }, []);

  const handleScroll = useCallback(() => {
    if (!ref.current) return;
    const i = Math.round(ref.current.scrollTop / 44);
    const clamped = Math.max(0, Math.min(options.length-1, i));
    if (options[clamped] !== value) onChange(options[clamped]);
  }, [options, value, onChange]);

  return (
    <div className="scroll-picker">
      <div className="scroll-picker-fade"/>
      <div className="scroll-picker-line"/>
      <div ref={ref} className="scroll-picker-inner no-scroll" onScroll={handleScroll}>
        <div style={{height:88}}/>
        {options.map(o => (
          <div key={o} className="scroll-picker-item"
            style={{color: o===value ? CYAN : "var(--text3)"}}
            onClick={() => onChange(o)}>
            {o}{unit}
          </div>
        ))}
        <div style={{height:88}}/>
      </div>
    </div>
  );
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Modal({title, onClose, children}) {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-sheet" onClick={e=>e.stopPropagation()}>
        <div className="modal-handle"/>
        <div className="modal-header">
          <span className="modal-title">{title}</span>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>
        <div className="modal-body">{children}</div>
      </div>
    </div>
  );
}

// â”€â”€ CatTabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CatTabs({cats, sel, onSel}) {
  return (
    <div className="cat-tabs no-scroll">
      {cats.map(c => (
        <button key={c} className={"pill " + (sel===c ? "pill-active" : "pill-inactive")} onClick={() => onSel(c)}>
          {c}
        </button>
      ))}
    </div>
  );
}

// â”€â”€ ExPicker modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExPickerModal({sessions, customExercises, onAdd, onClose, onAddCustom}) {
  const [selCat, setSelCat] = useState(Object.keys(EXERCISES)[0]);
  const [customModal, setCustomModal] = useState(false);
  const [customName, setCustomName] = useState("");
  const [customCat, setCustomCat] = useState("Autre");

  const allCats = {...EXERCISES};
  if (customExercises.length) allCats["Mes exercices"] = customExercises.map(e=>e.name);
  const catKeys = Object.keys(allCats);

  const saveCustom = () => {
    if (!customName.trim()) return;
    const ex = {name:customName.trim(), cat:customCat, custom:true};
    onAddCustom(ex);
    onAdd(ex);
    setCustomModal(false);
  };

  if (customModal) return (
    <Modal title="Nouvel exercice" onClose={() => setCustomModal(false)}>
      <label className="label">Nom</label>
      <input className="input" value={customName} onChange={e=>setCustomName(e.target.value)} placeholder="ex: Curl concentrÃ©..." style={{marginBottom:14}}/>
      <label className="label">CatÃ©gorie</label>
      <div className="cat-tabs no-scroll" style={{flexWrap:"wrap",marginBottom:16}}>
        {[...Object.keys(EXERCISES),"Autre"].map(c => (
          <button key={c} className={"pill " + (customCat===c ? "pill-active" : "pill-inactive")} onClick={()=>setCustomCat(c)}>{c}</button>
        ))}
      </div>
      <button className="btn-primary" onClick={saveCustom}>CrÃ©er l'exercice</button>
    </Modal>
  );

  return (
    <Modal title="Choisir un exercice" onClose={onClose}>
      <CatTabs cats={catKeys} sel={selCat} onSel={setSelCat}/>
      <div style={{marginBottom:12}}>
        {(allCats[selCat]||[]).map(ex => (
          <div key={ex} className="ex-item" onClick={() => onAdd({name:ex,cat:selCat})}>
            <span style={{flex:1,fontWeight:600,fontSize:15}}>{ex}</span>
            <span style={{color:CYAN,fontSize:20}}>+</span>
          </div>
        ))}
      </div>
      <button className="btn-ghost" onClick={() => setCustomModal(true)}>âœï¸ Exercice personnalisÃ©</button>
    </Modal>
  );
}

// â”€â”€ RadarChart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function RadarChart({measures}) {
  const n=RADAR_KEYS.length, cx=110, cy=110, r=80;
  const angle = i => (Math.PI*2*i/n) - Math.PI/2;
  const rings = [0.25,0.5,0.75,1];

  const ringPts = ratio => RADAR_KEYS.map((_,i)=>{
    const a=angle(i);
    return `${cx+r*ratio*Math.cos(a)},${cy+r*ratio*Math.sin(a)}`;
  }).join(" ");

  const dataPts = RADAR_KEYS.map((k,i)=>{
    const v=measures[k]||0;
    const ratio=Math.max(0,Math.min(1,(v-20)/120));
    const a=angle(i);
    return `${cx+r*ratio*Math.cos(a)},${cy+r*ratio*Math.sin(a)}`;
  }).join(" ");

  const hasData = RADAR_KEYS.some(k=>measures[k]>0);

  return (
    <svg viewBox="0 0 220 220" style={{width:"100%",maxWidth:260,margin:"0 auto",display:"block"}}>
      {rings.map(r2 => <polygon key={r2} fill="none" stroke="var(--border)" strokeWidth="1" points={ringPts(r2)}/>)}
      {RADAR_KEYS.map((_,i) => {
        const a=angle(i);
        return <line key={i} x1={cx} y1={cy} x2={cx+r*Math.cos(a)} y2={cy+r*Math.sin(a)} stroke="var(--border)" strokeWidth="1"/>;
      })}
      {hasData && <polygon points={dataPts} fill={`${CYAN}25`} stroke={CYAN} strokeWidth="2"/>}
      {RADAR_KEYS.map((_,i) => {
        const a=angle(i);
        const lx=cx+(r+20)*Math.cos(a), ly=cy+(r+20)*Math.sin(a);
        return <text key={i} x={lx} y={ly} textAnchor="middle" dominantBaseline="middle" fill="var(--text3)" fontSize="9" fontWeight="bold">{RADAR_LABELS[i]}</text>;
      })}
    </svg>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function HomeScreen({sessions, onStart}) {
  const last = sessions[sessions.length-1];
  const weekTon = sessions.filter(s=>s.date>=weekStart()).reduce((t,s)=>t+(s.tonnage||0),0);
  const totalSessions = sessions.length;
  const streak = (() => {
    let s=0, d=new Date(); d.setHours(0,0,0,0);
    for (let i=0;i<30;i++) {
      const dayMs = d.getTime();
      const found = sessions.some(se => { const sd=new Date(se.date); sd.setHours(0,0,0,0); return sd.getTime()===dayMs; });
      if (found) s++;
      else if (i>0) break;
      d.setDate(d.getDate()-1);
    }
    return s;
  })();

  return (
    <div className="page page-top fade-in">
      {/* Header */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:24}}>
        <div>
          <h1 style={{fontSize:32,fontWeight:900,letterSpacing:-1,lineHeight:1}}>OVERLOAD</h1>
          <p style={{fontSize:13,color:"var(--text3)",marginTop:4}}>Charge. Progresse. RÃ©pÃ¨te.</p>
        </div>
        <DumbbellLogo size={44}/>
      </div>

      {/* CTA */}
      <button className="btn-primary validate-btn" onClick={onStart} style={{marginBottom:16,fontSize:17,padding:"18px"}}>
        âš¡ DÃ‰MARRER UNE SÃ‰ANCE
      </button>

      {/* Stats */}
      <div className="stats-2" style={{marginBottom:12}}>
        <div className="card">
          <p className="section-title" style={{marginBottom:6}}>Tonnage semaine</p>
          <p style={{fontSize:26,fontWeight:900,color:CYAN,lineHeight:1}}>{weekTon.toLocaleString()}</p>
          <p style={{fontSize:12,color:"var(--text3)",marginTop:2}}>kg soulevÃ©s</p>
        </div>
        <div className="card">
          <p className="section-title" style={{marginBottom:6}}>SÃ©ances totales</p>
          <p style={{fontSize:26,fontWeight:900,lineHeight:1}}>{totalSessions}</p>
          <p style={{fontSize:12,color:"var(--text3)",marginTop:2}}>depuis le dÃ©but</p>
        </div>
      </div>

      {streak > 0 && (
        <div className="card" style={{marginBottom:12,display:"flex",alignItems:"center",gap:12}}>
          <span style={{fontSize:28}}>ğŸ”¥</span>
          <div>
            <p style={{fontWeight:800,fontSize:15}}>SÃ©rie de {streak} jour{streak>1?"s":""} !</p>
            <p style={{fontSize:12,color:"var(--text3)"}}>Continue comme Ã§a</p>
          </div>
        </div>
      )}

      {/* Last session */}
      {last ? (
        <div className="card">
          <p className="section-title" style={{marginBottom:10}}>DerniÃ¨re sÃ©ance</p>
          <p style={{fontWeight:800,fontSize:16}}>{last.name}</p>
          <p style={{fontSize:13,color:"var(--text3)",marginTop:2}}>{fmt(last.date)} Â· {last.duration||"?"} min</p>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:10}}>
            <p style={{fontSize:15,fontWeight:700,color:CYAN}}>{(last.tonnage||0).toLocaleString()} kg</p>
            {last.rpe && <span className={"pill " + (last.rpe<=3?"rpe-easy":last.rpe<=7?"rpe-med":"rpe-hard")}>RPE {last.rpe}</span>}
          </div>
        </div>
      ) : (
        <div className="card" style={{textAlign:"center",padding:"32px 16px"}}>
          <p style={{fontSize:48,marginBottom:8}}>ğŸ‹ï¸</p>
          <p style={{color:"var(--text3)"}}>Aucune sÃ©ance encore. Lance-toi !</p>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function TemplatesScreen({templates, setTemplates, customExercises, setCustomExercises}) {
  const [creating, setCreating] = useState(false);
  const [newName, setNewName]   = useState("");
  const [newExs, setNewExs]     = useState([]);
  const [exModal, setExModal]   = useState(false);

  const PRESET_NAMES = ["Push","Pull","Legs","Full Body","Upper","Lower","Bras","Cardio"];

  const addEx = ex => { setNewExs(p=>[...p,ex]); setExModal(false); };
  const addCustom = ex => setCustomExercises(p=>[...p,ex]);

  const save = () => {
    if (!newName.trim() || !newExs.length) return;
    setTemplates(p=>[...p,{id:Date.now(),name:newName,exercises:newExs}]);
    setCreating(false); setNewName(""); setNewExs([]);
  };

  return (
    <div className="page page-top fade-in">
      <h2 style={{fontSize:22,fontWeight:900,marginBottom:20}}>Templates</h2>

      {templates.length===0 && !creating && (
        <div className="card" style={{textAlign:"center",padding:"32px 16px",marginBottom:12}}>
          <p style={{fontSize:36,marginBottom:8}}>ğŸ“‹</p>
          <p style={{color:"var(--text3)"}}>CrÃ©e ta premiÃ¨re sÃ©ance type</p>
        </div>
      )}

      {templates.map(t => (
        <div key={t.id} className="card" style={{marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
            <div style={{flex:1}}>
              <p style={{fontWeight:800,fontSize:16}}>{t.name}</p>
              <p style={{fontSize:13,color:"var(--text3)",marginTop:2}}>{t.exercises.length} exercices</p>
            </div>
            <button onClick={()=>setTemplates(p=>p.filter(x=>x.id!==t.id))}
              style={{background:"none",border:"none",color:"var(--text3)",fontSize:22,cursor:"pointer",padding:"0 4px",lineHeight:1}}>Ã—</button>
          </div>
          <div style={{display:"flex",flexWrap:"wrap",gap:6,marginTop:10}}>
            {t.exercises.slice(0,4).map((e,i) => (
              <span key={i} className="pill pill-ghost" style={{fontSize:11}}>{e.name}</span>
            ))}
            {t.exercises.length>4 && <span style={{fontSize:12,color:"var(--text3)",alignSelf:"center"}}>+{t.exercises.length-4}</span>}
          </div>
        </div>
      ))}

      {!creating ? (
        <button className="btn-ghost" onClick={()=>setCreating(true)} style={{marginTop:4}}>+ Nouveau template</button>
      ) : (
        <div className="card fade-in" style={{marginBottom:10}}>
          <p style={{fontWeight:700,marginBottom:10}}>Nom de la sÃ©ance</p>
          <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:16}}>
            {PRESET_NAMES.map(n => (
              <button key={n} className={"pill " + (newName===n?"pill-active":"pill-inactive")} onClick={()=>setNewName(n)}>{n}</button>
            ))}
          </div>

          <p style={{fontWeight:700,marginBottom:10}}>Exercices ({newExs.length})</p>
          {newExs.map((e,i) => (
            <div key={i} className="set-row">
              <span style={{flex:1,fontWeight:600}}>{e.name}{e.custom && <span style={{color:CYAN,marginLeft:4}}>â˜…</span>}</span>
              <button className="set-del" onClick={()=>setNewExs(p=>p.filter((_,j)=>j!==i))}>Ã—</button>
            </div>
          ))}

          <button className="btn-ghost" onClick={()=>setExModal(true)} style={{marginBottom:16}}>+ Ajouter un exercice</button>

          <div style={{display:"flex",gap:8}}>
            <button className="btn-secondary" style={{flex:1}} onClick={()=>{setCreating(false);setNewExs([]);setNewName("");}}>Annuler</button>
            <button className="btn-primary" style={{flex:1,padding:"12px"}} onClick={save}>Sauvegarder</button>
          </div>
        </div>
      )}

      {exModal && (
        <ExPickerModal sessions={[]} customExercises={customExercises} onAdd={addEx} onClose={()=>setExModal(false)} onAddCustom={addCustom}/>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” SESSION LIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SessionScreen({templates, sessions, customExercises, setCustomExercises, onSave}) {
  const [phase, setPhase]         = useState("setup");
  const [sessionName, setName]    = useState("");
  const [exercises, setExercises] = useState([]);
  const [activeEx, setActiveEx]   = useState(0);
  const [exModal, setExModal]     = useState(false);
  const [selWeight, setSelWeight] = useState(60);
  const [manualW, setManualW]     = useState("");
  const [selReps, setSelReps]     = useState(10);
  const [rpe, setRpe]             = useState(null);
  const startTime = useRef(Date.now());

  const effectiveW = manualW !== "" ? (parseFloat(manualW)||selWeight) : selWeight;
  const totalTon   = exercises.reduce((t,e)=>t+calcTon(e.sets||[]),0);

  const loadTemplate = t => {
    setName(t.name);
    setExercises(t.exercises.map(ex => {
      const lw = getLastWeight(sessions, ex.name);
      return {...ex, sets:[], lastSets:getLastSession(sessions,ex.name), defaultW:lw||60};
    }));
    setPhase("live");
  };

  useEffect(() => {
    const ex = exercises[activeEx];
    if (ex) {
      const w = ex.defaultW||60;
      setSelWeight(WEIGHT_OPTIONS.includes(w)?w:60);
      setManualW("");
    }
  }, [activeEx, exercises.length]);

  const addEx = ex => {
    const lw = getLastWeight(sessions, ex.name);
    setExercises(p=>[...p,{...ex,sets:[],lastSets:getLastSession(sessions,ex.name),defaultW:lw||60}]);
    setActiveEx(exercises.length);
    setExModal(false);
  };

  const addSet = () => {
    setExercises(p=>p.map((e,i)=>i===activeEx
      ? {...e,sets:[...e.sets,{weight:effectiveW,reps:selReps}],defaultW:effectiveW}
      : e));
    setManualW("");
  };

  const removeSet = (ei,si) => setExercises(p=>p.map((e,i)=>i===ei?{...e,sets:e.sets.filter((_,j)=>j!==si)}:e));

  const finish = () => {
    const s = {
      id:Date.now(), name:sessionName||"SÃ©ance libre",
      date:Date.now(),
      duration:Math.round((Date.now()-startTime.current)/60000),
      exercises, tonnage:totalTon, rpe
    };
    onSave(s);
    setPhase("done");
  };

  // DONE
  if (phase==="done") return (
    <div className="done-screen fade-in">
      <div className="trophy">ğŸ†</div>
      <h2 style={{fontSize:26,fontWeight:900}}>SÃ©ance terminÃ©e !</h2>
      <p style={{fontSize:36,fontWeight:900,color:CYAN}}>{totalTon.toLocaleString()} kg</p>
      <p style={{color:"var(--text3)"}}>soulevÃ©s aujourd'hui</p>
      <button className="btn-primary" style={{width:220,marginTop:8}}
        onClick={()=>{setPhase("setup");setExercises([]);setName("");setRpe(null);startTime.current=Date.now();}}>
        Nouvelle sÃ©ance
      </button>
    </div>
  );

  // SETUP
  if (phase==="setup") return (
    <div className="page page-top fade-in">
      <h2 style={{fontSize:22,fontWeight:900,marginBottom:20}}>SÃ©ance</h2>
      {templates.length>0 && (
        <>
          <p className="section-title">Depuis un template</p>
          {templates.map(t=>(
            <div key={t.id} className="card" style={{marginBottom:10,display:"flex",alignItems:"center",cursor:"pointer"}}
              onClick={()=>loadTemplate(t)}>
              <div style={{flex:1}}>
                <p style={{fontWeight:800,fontSize:15}}>{t.name}</p>
                <p style={{fontSize:12,color:"var(--text3)"}}>{t.exercises.length} exercices</p>
              </div>
              <span style={{fontSize:24,color:CYAN}}>â–¶</span>
            </div>
          ))}
          <div className="sep"><div className="sep-line"/><span className="sep-text">ou</span><div className="sep-line"/></div>
        </>
      )}
      <button className="btn-secondary" style={{width:"100%",fontSize:15}} onClick={()=>setPhase("live")}>
        SÃ©ance libre âš¡
      </button>
    </div>
  );

  // LIVE
  const curEx = exercises[activeEx];

  return (
    <div className="page page-top fade-in">
      {/* Header */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16}}>
        <div>
          <h2 style={{fontSize:17,fontWeight:900}}>{sessionName||"SÃ©ance libre"}</h2>
          <p style={{fontSize:13,fontWeight:700,color:CYAN}}>{totalTon.toLocaleString()} kg total</p>
        </div>
        <button className="pill" style={{background:"rgba(239,68,68,0.15)",color:"#f87171",border:"1px solid rgba(239,68,68,0.3)"}}
          onClick={()=>setPhase("end")}>Fin</button>
      </div>

      {/* Exercise tabs */}
      <div className="ex-tabs no-scroll" style={{marginBottom:14}}>
        {exercises.map((e,i)=>(
          <button key={i} className={"pill " + (activeEx===i?"pill-active":"pill-inactive")} onClick={()=>setActiveEx(i)}>
            {e.name.split(" ").slice(0,2).join(" ")}
            {e.sets?.length>0 && <span style={{marginLeft:4,opacity:.7}}>({e.sets.length})</span>}
          </button>
        ))}
        <button className="pill pill-ghost" style={{color:CYAN,borderColor:CYAN,background:"rgba(0,212,255,0.08)"}}
          onClick={()=>setExModal(true)}>+ Ex.</button>
      </div>

      {curEx ? (
        <>
          {/* Last session */}
          {curEx.lastSets && (
            <div style={{marginBottom:12}}>
              <p className="section-title">DerniÃ¨re fois</p>
              <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                {curEx.lastSets.map((s,i)=>(
                  <span key={i} className="last-set-badge">{s.weight}kg Ã— {s.reps}</span>
                ))}
              </div>
            </div>
          )}

          {/* Sets */}
          {curEx.sets?.length>0 && (
            <div style={{marginBottom:14}}>
              {curEx.sets.map((s,i)=>(
                <div key={i} className="set-row">
                  <span className="set-num">S{i+1}</span>
                  <span className="set-info">{s.weight} kg Ã— {s.reps}</span>
                  <span className="set-tonnage">{s.weight*s.reps} kg</span>
                  <button className="set-del" onClick={()=>removeSet(activeEx,i)}>Ã—</button>
                </div>
              ))}
            </div>
          )}

          {/* Weight picker */}
          <div className="card" style={{marginBottom:12}}>
            <p className="section-title">Poids (kg)</p>
            <div style={{display:"flex",gap:12,alignItems:"center",justifyContent:"center"}}>
              <ScrollPicker options={WEIGHT_OPTIONS} value={selWeight} onChange={v=>{setSelWeight(v);setManualW("");}}/>
              <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8}}>
                <p style={{fontSize:11,color:"var(--text3)"}}>ou saisir</p>
                <input type="number" inputMode="decimal" className="input"
                  value={manualW} onChange={e=>setManualW(e.target.value)}
                  placeholder={String(selWeight)}
                  style={{width:72,textAlign:"center",fontSize:18,fontWeight:800,padding:"10px 8px",borderColor:manualW?CYAN:"var(--border)"}}/>
                {manualW && <p style={{fontSize:11,color:CYAN,fontWeight:700}}>â†’ {effectiveW} kg</p>}
              </div>
            </div>
          </div>

          {/* Reps picker */}
          <div className="card" style={{marginBottom:14}}>
            <p className="section-title">RÃ©pÃ©titions</p>
            <div className="bubble-grid">
              {REPS_OPTIONS.map(r=>(
                <button key={r} className={"bubble " + (selReps===r?"bubble-active":"bubble-inactive")}
                  onClick={()=>setSelReps(r)}>{r}</button>
              ))}
            </div>
          </div>

          {/* Validate */}
          <button className="btn-primary validate-btn" onClick={addSet}>
            âœ“ Valider â€” {effectiveW} kg Ã— {selReps}
          </button>
        </>
      ) : (
        <div className="card" style={{textAlign:"center",padding:"32px 16px"}}>
          <p style={{color:"var(--text3)",marginBottom:12}}>Ajoute un exercice pour commencer</p>
          <button className="btn-primary" style={{width:180,margin:"0 auto"}} onClick={()=>setExModal(true)}>+ Exercice</button>
        </div>
      )}

      {/* End modal */}
      {phase==="end" && (
        <Modal title="Fin de sÃ©ance" onClose={()=>setPhase("live")}>
          <p style={{fontSize:13,color:"var(--text3)",marginBottom:14}}>Ã‰value ton effort (RPE)</p>
          <div className="rpe-grid">
            {RPE_OPTIONS.map(r=>(
              <button key={r} className={"bubble " + (rpe===r?"bubble-active":"bubble-inactive")} onClick={()=>setRpe(r)}>{r}</button>
            ))}
          </div>
          <div className="stats-3" style={{marginBottom:20}}>
            <div style={{background:"rgba(34,197,94,0.1)",borderRadius:10,padding:"10px 8px",textAlign:"center"}}>
              <p style={{color:"#4ade80",fontWeight:800,fontSize:13}}>1â€“3</p>
              <p style={{fontSize:11,color:"var(--text3)"}}>Facile</p>
            </div>
            <div style={{background:"rgba(251,191,36,0.1)",borderRadius:10,padding:"10px 8px",textAlign:"center"}}>
              <p style={{color:"#fbbf24",fontWeight:800,fontSize:13}}>4â€“7</p>
              <p style={{fontSize:11,color:"var(--text3)"}}>ModÃ©rÃ©</p>
            </div>
            <div style={{background:"rgba(239,68,68,0.1)",borderRadius:10,padding:"10px 8px",textAlign:"center"}}>
              <p style={{color:"#f87171",fontWeight:800,fontSize:13}}>8â€“10</p>
              <p style={{fontSize:11,color:"var(--text3)"}}>Intense</p>
            </div>
          </div>
          <button className="btn-primary" onClick={finish}>Sauvegarder ğŸ†</button>
        </Modal>
      )}

      {exModal && (
        <ExPickerModal sessions={sessions} customExercises={customExercises}
          onAdd={addEx} onClose={()=>setExModal(false)}
          onAddCustom={ex=>setCustomExercises(p=>[...p,ex])}/>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function HistoryScreen({sessions}) {
  const [subTab, setSubTab] = useState("list");
  const [sel, setSel]       = useState(null);

  const tWeek  = sessions.filter(s=>s.date>=weekStart()).reduce((t,s)=>t+(s.tonnage||0),0);
  const tMonth = sessions.filter(s=>s.date>=monthStart()).reduce((t,s)=>t+(s.tonnage||0),0);
  const tAll   = sessions.reduce((t,s)=>t+(s.tonnage||0),0);

  // Weekly bars (8 weeks)
  const weeklyData = () => {
    const weeks = [];
    for (let i=7;i>=0;i--) {
      const ws=weekStart()-i*7*86400000, we=ws+7*86400000;
      const t=sessions.filter(s=>s.date>=ws&&s.date<we).reduce((a,s)=>a+(s.tonnage||0),0);
      weeks.push({label:new Date(ws).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"}), t});
    }
    return weeks;
  };
  const wData=weeklyData(), maxW=Math.max(...wData.map(w=>w.t),1);

  const topExs = Object.values(
    sessions.flatMap(s=>s.exercises||[]).reduce((acc,ex)=>{
      if (!acc[ex.name]) acc[ex.name]={name:ex.name,tonnage:0};
      acc[ex.name].tonnage+=calcTon(ex.sets||[]);
      return acc;
    },{})
  ).sort((a,b)=>b.tonnage-a.tonnage).slice(0,5);

  return (
    <div className="page page-top fade-in">
      <h2 style={{fontSize:22,fontWeight:900,marginBottom:16}}>Historique</h2>

      {/* Sub tabs */}
      <div style={{display:"flex",gap:8,marginBottom:16}}>
        {[["list","ğŸ“‹ SÃ©ances"],["stats","ğŸ“Š Stats"]].map(([id,lbl])=>(
          <button key={id} className={"pill " + (subTab===id?"pill-active":"pill-inactive")}
            style={{flex:1,padding:"9px",fontSize:13}} onClick={()=>setSubTab(id)}>{lbl}</button>
        ))}
      </div>

      {/* STATS */}
      {subTab==="stats" && (
        <>
          <div className="stats-3" style={{marginBottom:12}}>
            {[["Semaine",tWeek],["Mois",tMonth],["Total",tAll]].map(([l,v])=>(
              <div key={l} className="card-sm" style={{textAlign:"center"}}>
                <p className="section-title" style={{fontSize:9}}>{l}</p>
                <p style={{fontSize:17,fontWeight:900,color:CYAN}}>{v>=1000?(v/1000).toFixed(1)+"t":v.toLocaleString()}</p>
                <p style={{fontSize:10,color:"var(--text3)"}}>kg</p>
              </div>
            ))}
          </div>

          <div className="card" style={{marginBottom:12}}>
            <p className="section-title">8 derniÃ¨res semaines</p>
            <div className="bar-chart">
              {wData.map((w,i)=>(
                <div key={i} className="bar-col">
                  <div className="bar-rect"
                    style={{height:`${Math.max(3,(w.t/maxW)*100)}%`,
                      background:i===7?CYAN:"var(--surface2)",
                      boxShadow:i===7?`0 0 10px ${CYAN}88`:""}}/>
                  <span className="bar-label">{w.label}</span>
                </div>
              ))}
            </div>
          </div>

          {topExs.length>0 && (
            <div className="card">
              <p className="section-title">Top exercices</p>
              {topExs.map((ex,i)=>(
                <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:i<topExs.length-1?"1px solid var(--border)":"none"}}>
                  <span style={{fontSize:14,color:"var(--text2)"}}>{ex.name}</span>
                  <span style={{fontWeight:700,fontSize:14,color:CYAN}}>{ex.tonnage.toLocaleString()} kg</span>
                </div>
              ))}
            </div>
          )}
        </>
      )}

      {/* LIST */}
      {subTab==="list" && (
        <>
          {sessions.length===0 && (
            <div className="card" style={{textAlign:"center",padding:"40px 16px"}}>
              <p style={{fontSize:40,marginBottom:8}}>ğŸ“Š</p>
              <p style={{color:"var(--text3)"}}>Aucune sÃ©ance enregistrÃ©e</p>
            </div>
          )}
          {[...sessions].reverse().map(s=>(
            <div key={s.id} className="card" style={{marginBottom:10,cursor:"pointer"}} onClick={()=>setSel(s)}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                <div>
                  <p style={{fontWeight:800,fontSize:15}}>{s.name}</p>
                  <p style={{fontSize:12,color:"var(--text3)",marginTop:2}}>{fmt(s.date)} Â· {s.duration||"?"} min</p>
                </div>
                <div style={{textAlign:"right"}}>
                  <p style={{fontWeight:900,fontSize:16,color:CYAN}}>{(s.tonnage||0).toLocaleString()} kg</p>
                  {s.rpe && <span className={"pill " + (s.rpe<=3?"rpe-easy":s.rpe<=7?"rpe-med":"rpe-hard")} style={{fontSize:10}}>RPE {s.rpe}</span>}
                </div>
              </div>
              <div style={{display:"flex",flexWrap:"wrap",gap:6,marginTop:8}}>
                {s.exercises?.slice(0,3).map((e,i)=>(
                  <span key={i} className="pill pill-ghost" style={{fontSize:10}}>{e.name}</span>
                ))}
                {s.exercises?.length>3 && <span style={{fontSize:11,color:"var(--text3)",alignSelf:"center"}}>+{s.exercises.length-3}</span>}
              </div>
            </div>
          ))}
        </>
      )}

      {/* Session detail modal */}
      {sel && (
        <Modal title={sel.name} onClose={()=>setSel(null)}>
          <p style={{fontSize:13,color:"var(--text3)",marginBottom:16}}>{fmt(sel.date)} Â· {sel.duration||"?"} min Â· RPE {sel.rpe||"â€”"}</p>
          {sel.exercises?.map((e,i)=>(
            <div key={i} style={{marginBottom:16}}>
              <p style={{fontWeight:800,fontSize:14,color:CYAN,marginBottom:8}}>{e.name}</p>
              {e.sets?.map((s,j)=>(
                <div key={j} style={{display:"flex",justifyContent:"space-between",fontSize:13,padding:"8px 0",borderBottom:"1px solid var(--border)"}}>
                  <span style={{color:"var(--text3)"}}>SÃ©rie {j+1}</span>
                  <span style={{fontWeight:700}}>{s.weight} kg Ã— {s.reps}</span>
                  <span style={{color:"var(--text3)"}}>{s.weight*s.reps} kg</span>
                </div>
              ))}
              <p style={{textAlign:"right",fontSize:12,color:CYAN,marginTop:6,fontWeight:700}}>
                {calcTon(e.sets||[]).toLocaleString()} kg total
              </p>
            </div>
          ))}
        </Modal>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ProfileScreen({profile, setProfile}) {
  const [wModal, setWModal]       = useState(false);
  const [mModal, setMModal]       = useState(null);
  const [tempW, setTempW]         = useState(75);
  const [tempM, setTempM]         = useState(35);

  const lastW   = profile.weight[profile.weight.length-1];
  const lastM   = profile.measurements[profile.measurements.length-1] || {};
  const prevW   = profile.weight.length>=2 ? profile.weight[profile.weight.length-2].val : null;
  const diff    = lastW && prevW ? (lastW.val - prevW) : null;

  const saveWeight = () => {
    setProfile(p=>({...p,weight:[...p.weight,{val:tempW,date:Date.now()}]}));
    setWModal(false);
  };

  const saveMeasure = () => {
    const upd = {...lastM,[mModal.key]:tempM,date:Date.now()};
    setProfile(p=>({...p,measurements:p.measurements.length?[...p.measurements.slice(0,-1),upd]:[upd]}));
    setMModal(null);
  };

  return (
    <div className="page page-top fade-in">
      <h2 style={{fontSize:22,fontWeight:900,marginBottom:16}}>Mon Profil</h2>

      {/* Weight card */}
      <div className="card" style={{marginBottom:10}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <p className="section-title" style={{margin:0}}>Poids de corps</p>
          <button className="pill pill-active" style={{fontSize:11,padding:"5px 12px"}}
            onClick={()=>{setTempW(lastW?.val||75);setWModal(true);}}>Mettre Ã  jour</button>
        </div>
        <div style={{display:"flex",alignItems:"flex-end",gap:8}}>
          <p style={{fontSize:40,fontWeight:900,lineHeight:1}}>{lastW?.val||"â€”"}</p>
          <p style={{fontSize:18,color:"var(--text3)",marginBottom:4}}>kg</p>
          {diff!==null && (
            <p style={{fontSize:14,fontWeight:800,marginBottom:4,color:diff>0?"#f87171":"#4ade80"}}>
              {diff>0?"+":""}{diff.toFixed(1)}
            </p>
          )}
        </div>
        {lastW && <p style={{fontSize:12,color:"var(--text3)",marginTop:4}}>Mis Ã  jour le {fmt(lastW.date)}</p>}

        {profile.weight.length>1 && (
          <div style={{marginTop:12}}>
            <p className="section-title">Ã‰volution</p>
            <div className="bar-chart" style={{height:60}}>
              {profile.weight.slice(-8).map((w,i,arr)=>{
                const vals=arr.map(x=>x.val), mn=Math.min(...vals), mx=Math.max(...vals);
                const ratio=mx===mn?0.5:(w.val-mn)/(mx-mn);
                return (
                  <div key={i} className="bar-col">
                    <div className="bar-rect" style={{height:`${Math.max(5,ratio*100)}%`,background:i===arr.length-1?CYAN:"var(--surface2)"}}/>
                    <span className="bar-label">{fmtShort(w.date)}</span>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>

      {/* Measurements */}
      <div className="card" style={{marginBottom:10}}>
        <p className="section-title">Mensurations (cm)</p>
        <div className="meas-grid">
          {MEASUREMENTS.map(m=>(
            <button key={m.key} className="meas-btn"
              onClick={()=>{setTempM(lastM[m.key]||35);setMModal(m);}}>
              <p className="label" style={{margin:0,fontSize:10}}>{m.label}</p>
              <p className="meas-val">{lastM[m.key]||"â€”"}{lastM[m.key]?" cm":""}</p>
            </button>
          ))}
        </div>
      </div>

      {/* Radar */}
      <div className="card">
        <p className="section-title">Silhouette proportions</p>
        <div className="radar-wrap">
          <RadarChart measures={lastM}/>
        </div>
        {!RADAR_KEYS.some(k=>lastM[k]) && (
          <p style={{fontSize:12,color:"var(--text3)",textAlign:"center",marginTop:4}}>Saisis tes mensurations pour voir le radar</p>
        )}
      </div>

      {/* Weight modal */}
      {wModal && (
        <Modal title="Poids de corps" onClose={()=>setWModal(false)}>
          <div style={{display:"flex",justifyContent:"center",marginBottom:20}}>
            <ScrollPicker options={BODY_WEIGHT} value={tempW} onChange={setTempW} unit=" kg"/>
          </div>
          <button className="btn-primary" onClick={saveWeight}>Enregistrer {tempW} kg</button>
        </Modal>
      )}

      {/* Measure modal */}
      {mModal && (
        <Modal title={mModal.label} onClose={()=>setMModal(null)}>
          <div style={{display:"flex",justifyContent:"center",marginBottom:20}}>
            <ScrollPicker options={MEASURE_OPTS} value={tempM} onChange={setTempM} unit=" cm"/>
          </div>
          <button className="btn-primary" onClick={saveMeasure}>Enregistrer {tempM} cm</button>
        </Modal>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOT APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN â€” DONNÃ‰ES (Export / Import / Reset)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DataScreen({sessions, templates, customExercises, profile, onImport, syncStatus}) {
  const [confirmReset, setConfirmReset] = useState(false);
  const [importError,  setImportError]  = useState("");
  const [importOk,     setImportOk]     = useState(false);
  const [dragging,     setDragging]     = useState(false);

  // â”€â”€ Stats rapides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const totalTon = sessions.reduce((t,s)=>t+(s.tonnage||0),0);
  const lastBackup = lsGet("ol:lastBackup", null);
  const lastSync   = lsGet("ol:lastSync",   null);
  const [ghStatus, setGhStatus] = useState(syncStatus);
  useEffect(() => { setGhStatus(syncStatus); }, [syncStatus]);

  // â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const doExport = () => {
    const data = {
      version: 1,
      exportedAt: new Date().toISOString(),
      sessions,
      templates,
      customExercises,
      profile
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    const date = new Date().toLocaleDateString("fr-FR").replace(/\//g,"-");
    a.href = url;
    a.download = `overload-backup-${date}.json`;
    a.click();
    URL.revokeObjectURL(url);
    lsSet("ol:lastBackup", new Date().toISOString());
  };

  // â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const processFile = (file) => {
    if (!file) return;
    setImportError("");
    setImportOk(false);
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.sessions || !data.profile) throw new Error("Fichier invalide");
        onImport(data);
        setImportOk(true);
        setTimeout(() => setImportOk(false), 3000);
      } catch(err) {
        setImportError("Fichier invalide ou corrompu.");
      }
    };
    reader.readAsText(file);
  };

  const handleFileInput = e => processFile(e.target.files[0]);

  const handleDrop = e => {
    e.preventDefault();
    setDragging(false);
    processFile(e.dataTransfer.files[0]);
  };

  // â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const doReset = () => {
    onImport({
      version: 1,
      sessions: [],
      templates: DEFAULT_TEMPLATES,
      customExercises: [],
      profile: {weight:[], measurements:[{}]}
    });
    setConfirmReset(false);
  };

  return (
    <div className="page page-top fade-in">
      <h2 style={{fontSize:22,fontWeight:900,marginBottom:6}}>Mes DonnÃ©es</h2>
      <p style={{fontSize:13,color:"var(--text3)",marginBottom:20}}>Sauvegarde et restauration locale</p>

      {/* RÃ©sumÃ© */}
      <div className="card" style={{marginBottom:12}}>
        <p className="section-title">Contenu actuel</p>
        <div style={{display:"flex",flexDirection:"column",gap:10,marginTop:4}}>
          {[
            ["ğŸ’ª","SÃ©ances enregistrÃ©es", sessions.length],
            ["ğŸ“‹","Templates", templates.length],
            ["âš–ï¸","Tonnage total", totalTon.toLocaleString() + " kg"],
            ["ğŸ“","Mesures", profile.measurements.filter(m=>Object.keys(m).length>1).length + " entrÃ©es"],
          ].map(([icon,label,val])=>(
            <div key={label} style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <span style={{fontSize:14,color:"var(--text2)"}}>{icon} {label}</span>
              <span style={{fontWeight:800,fontSize:14,color:CYAN}}>{val}</span>
            </div>
          ))}
        </div>
        {/* Statut sync GitHub */}
        <div style={{marginTop:12,paddingTop:10,borderTop:"1px solid var(--border)",display:"flex",alignItems:"center",gap:8}}>
          <span style={{width:8,height:8,borderRadius:"50%",flexShrink:0,background:
            ghStatus==="ok"?"var(--green)":ghStatus==="syncing"?"var(--warn)":ghStatus==="error"?"var(--danger)":"var(--text3)"
          }}/>
          <span style={{fontSize:11,color:"var(--text3)"}}>
            {ghStatus==="ok"      && "GitHub sync â€” " + (lastSync ? "derniÃ¨re sync " + new Date(lastSync).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}) : "OK")}
            {ghStatus==="syncing" && "Synchronisation en coursâ€¦"}
            {ghStatus==="error"   && "Erreur de sync GitHub"}
            {ghStatus==="idle"    && "GitHub sync â€” en attente"}
          </span>
        </div>
      </div>

      {/* Export */}
      <div className="card" style={{marginBottom:12}}>
        <div style={{display:"flex",gap:12,alignItems:"flex-start",marginBottom:12}}>
          <span style={{fontSize:28}}>ğŸ“¤</span>
          <div>
            <p style={{fontWeight:800,fontSize:15}}>Exporter mes donnÃ©es</p>
            <p style={{fontSize:13,color:"var(--text3)",marginTop:3,lineHeight:1.5}}>
              TÃ©lÃ©charge un fichier <code style={{color:CYAN,fontSize:12}}>.json</code> avec toutes tes sÃ©ances, templates et mesures. Stocke-le sur Google Drive, iCloud ou par mail.
            </p>
          </div>
        </div>
        <button className="btn-primary" onClick={doExport} style={{fontSize:15}}>
          ğŸ“¤ TÃ©lÃ©charger la sauvegarde
        </button>
      </div>

      {/* Import */}
      <div className="card" style={{marginBottom:12}}>
        <div style={{display:"flex",gap:12,alignItems:"flex-start",marginBottom:12}}>
          <span style={{fontSize:28}}>ğŸ“¥</span>
          <div>
            <p style={{fontWeight:800,fontSize:15}}>Importer une sauvegarde</p>
            <p style={{fontSize:13,color:"var(--text3)",marginTop:3,lineHeight:1.5}}>
              Restaure tes donnÃ©es depuis un fichier de sauvegarde. Remplace les donnÃ©es actuelles.
            </p>
          </div>
        </div>

        {/* Drop zone */}
        <label
          onDragOver={e=>{e.preventDefault();setDragging(true);}}
          onDragLeave={()=>setDragging(false)}
          onDrop={handleDrop}
          style={{
            display:"block",
            border:`2px dashed ${dragging?CYAN:"var(--border)"}`,
            borderRadius:14,
            padding:"24px 16px",
            textAlign:"center",
            cursor:"pointer",
            background:dragging?"rgba(0,212,255,0.05)":"transparent",
            transition:"all 0.2s",
            marginBottom:importError||importOk?12:0
          }}>
          <input type="file" accept=".json" onChange={handleFileInput} style={{display:"none"}}/>
          <p style={{fontSize:24,marginBottom:6}}>ğŸ“</p>
          <p style={{fontWeight:700,fontSize:14,color:dragging?CYAN:"var(--text2)"}}>
            {dragging ? "RelÃ¢che pour importer" : "Appuie pour choisir un fichier"}
          </p>
          <p style={{fontSize:11,color:"var(--text3)",marginTop:4}}>Format .json uniquement</p>
        </label>

        {importError && (
          <div style={{background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.3)",borderRadius:10,padding:"10px 14px",fontSize:13,color:"#f87171"}}>
            âš ï¸ {importError}
          </div>
        )}
        {importOk && (
          <div style={{background:"rgba(0,255,157,0.08)",border:"1px solid rgba(0,255,157,0.3)",borderRadius:10,padding:"10px 14px",fontSize:13,color:"var(--green)"}}>
            âœ… DonnÃ©es importÃ©es avec succÃ¨s !
          </div>
        )}
      </div>

      {/* Reset */}
      <div className="card" style={{borderColor:"rgba(239,68,68,0.2)"}}>
        <div style={{display:"flex",gap:12,alignItems:"flex-start",marginBottom:12}}>
          <span style={{fontSize:28}}>ğŸ—‘ï¸</span>
          <div>
            <p style={{fontWeight:800,fontSize:15,color:"#f87171"}}>RÃ©initialiser</p>
            <p style={{fontSize:13,color:"var(--text3)",marginTop:3,lineHeight:1.5}}>
              Efface toutes tes donnÃ©es dÃ©finitivement. Action irrÃ©versible â€” exporte d'abord une sauvegarde.
            </p>
          </div>
        </div>

        {!confirmReset ? (
          <button onClick={()=>setConfirmReset(true)}
            style={{width:"100%",padding:"12px",borderRadius:12,border:"1px solid rgba(239,68,68,0.4)",background:"rgba(239,68,68,0.08)",color:"#f87171",fontWeight:700,fontSize:14,cursor:"pointer"}}>
            RÃ©initialiser toutes les donnÃ©es
          </button>
        ) : (
          <div style={{background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.3)",borderRadius:12,padding:14}}>
            <p style={{fontWeight:700,fontSize:14,color:"#f87171",marginBottom:10,textAlign:"center"}}>
              âš ï¸ Confirmer la suppression ?
            </p>
            <p style={{fontSize:12,color:"var(--text3)",textAlign:"center",marginBottom:14}}>
              {sessions.length} sÃ©ance{sessions.length>1?"s":""} seront perdues dÃ©finitivement.
            </p>
            <div style={{display:"flex",gap:8}}>
              <button className="btn-secondary" style={{flex:1}} onClick={()=>setConfirmReset(false)}>Annuler</button>
              <button onClick={doReset}
                style={{flex:1,padding:"12px",borderRadius:12,background:"#ef4444",color:"#fff",fontWeight:800,fontSize:14,border:"none",cursor:"pointer"}}>
                Tout supprimer
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

const TABS = [
  {id:"home", icon:"ğŸ ", label:"Accueil"},
  {id:"tpl",  icon:"ğŸ“‹", label:"Templates"},
  {id:"live", icon:"âš¡", label:"SÃ©ance"},
  {id:"hist", icon:"ğŸ“Š", label:"Historique"},
  {id:"prof", icon:"ğŸ‘¤", label:"Profil"},
  {id:"data", icon:"ğŸ’¾", label:"DonnÃ©es"},
];

function App() {
  const [tab, setTab]   = useState("home");
  const [ready, setReady] = useState(false);

  const [templates,        setTemplatesRaw]  = useState(DEFAULT_TEMPLATES);
  const [sessions,         setSessionsRaw]   = useState([]);
  const [customExercises,  setCustomExRaw]   = useState([]);
  const [profile,          setProfileRaw]    = useState({weight:[], measurements:[{}]});

  const [syncStatus, setSyncStatus] = useState("idle"); // idle | syncing | ok | error

  // â”€â”€ Charger : d'abord localStorage (instantanÃ©), puis GitHub (fresh) â”€â”€â”€
  useEffect(() => {
    // 1. Charge le cache local immÃ©diatement
    setTemplatesRaw(lsGet("ol:templates", DEFAULT_TEMPLATES));
    setSessionsRaw(lsGet("ol:sessions", []));
    setCustomExRaw(lsGet("ol:customEx", []));
    setProfileRaw(lsGet("ol:profile", {weight:[], measurements:[{}]}));
    setReady(true);

    // 2. Tente de rÃ©cupÃ©rer la version GitHub (plus rÃ©cente si autre appareil)
    setSyncStatus("syncing");
    ghRead().then(result => {
      if (!result) { setSyncStatus(lsGet("ol:syncStatus","idle")); return; }
      const d = result.data;
      lsSet("ol:gh_sha", result.sha);
      if (d.sessions)        { setSessionsRaw(d.sessions);        lsSet("ol:sessions",  d.sessions); }
      if (d.templates)       { setTemplatesRaw(d.templates);      lsSet("ol:templates", d.templates); }
      if (d.customExercises) { setCustomExRaw(d.customExercises); lsSet("ol:customEx",  d.customExercises); }
      if (d.profile)         { setProfileRaw(d.profile);          lsSet("ol:profile",   d.profile); }
      setSyncStatus("ok");
      lsSet("ol:syncStatus", "ok");
    });

    // Ã‰couter les changements de statut sync
    const handler = () => setSyncStatus(lsGet("ol:syncStatus","idle"));
    window.addEventListener("ol:syncStatusChange", handler);
    return () => window.removeEventListener("ol:syncStatusChange", handler);
  }, []);

  // â”€â”€ Helper : persist local + schedule GitHub sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const persist = (key, val, setter) => {
    const resolved = typeof val === "function" ? val(lsGet(key, [])) : val;
    setter(resolved);
    lsSet(key, resolved);
    // DÃ©clenche la sync GitHub avec toutes les donnÃ©es Ã  jour
    setTimeout(() => {
      scheduleSyncToGH({
        sessions:        lsGet("ol:sessions",  []),
        templates:       lsGet("ol:templates", DEFAULT_TEMPLATES),
        customExercises: lsGet("ol:customEx",  []),
        profile:         lsGet("ol:profile",   {weight:[], measurements:[{}]}),
        version: 1,
        updatedAt: new Date().toISOString()
      });
    }, 50);
  };

  const setTemplates = v => persist("ol:templates", v, setTemplatesRaw);
  const setSessions  = v => persist("ol:sessions",  v, setSessionsRaw);
  const setCustomEx  = v => persist("ol:customEx",  v, setCustomExRaw);
  const setProfile   = v => persist("ol:profile",   v, setProfileRaw);

  const saveSession = s => { setSessions(p=>[...p,s]); setTab("hist"); };

  const onImport = data => {
    if (data.sessions)         { setSessionsRaw(data.sessions);         lsSet("ol:sessions",  data.sessions); }
    if (data.templates)        { setTemplatesRaw(data.templates);       lsSet("ol:templates", data.templates); }
    if (data.customExercises)  { setCustomExRaw(data.customExercises);  lsSet("ol:customEx",  data.customExercises); }
    if (data.profile)          { setProfileRaw(data.profile);           lsSet("ol:profile",   data.profile); }
    // Force sync immÃ©diate aprÃ¨s import
    scheduleSyncToGH({ ...data, version:1, updatedAt: new Date().toISOString() });
  };

  if (!ready) return (
    <div style={{minHeight:"100dvh",background:"var(--bg)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:24}}>
      <DumbbellLogo size={56}/>
      <div className="loader"/>
    </div>
  );

  return (
    <div className="app">
      <div className="scroll-area no-scroll">
        {tab==="home" && <HomeScreen sessions={sessions} onStart={()=>setTab("live")}/>}
        {tab==="tpl"  && <TemplatesScreen templates={templates} setTemplates={setTemplates} customExercises={customExercises} setCustomExercises={setCustomEx}/>}
        {tab==="live" && <SessionScreen templates={templates} sessions={sessions} customExercises={customExercises} setCustomExercises={setCustomEx} onSave={saveSession}/>}
        {tab==="hist" && <HistoryScreen sessions={sessions}/>}
        {tab==="prof" && <ProfileScreen profile={profile} setProfile={setProfile}/>}
        {tab==="data" && <DataScreen sessions={sessions} templates={templates} customExercises={customExercises} profile={profile} onImport={onImport} syncStatus={syncStatus}/>}
      </div>

      <nav className="nav">
        {TABS.map(t=>(
          <button key={t.id} className={"nav-btn " + (tab===t.id?"active ":"") + (t.id==="live"?"session-btn":"")}
            onClick={()=>setTab(t.id)}>
            <span className="nav-icon">{t.icon}</span>
            <span className="nav-label">{t.label}</span>
            {t.id==="data" && syncStatus==="syncing" && <span style={{width:5,height:5,borderRadius:"50%",background:"var(--warn)",display:"block",marginTop:1}}/>}
            {t.id==="data" && syncStatus==="ok"      && <span style={{width:5,height:5,borderRadius:"50%",background:"var(--green)",display:"block",marginTop:1}}/>}
            {t.id==="data" && syncStatus==="error"   && <span style={{width:5,height:5,borderRadius:"50%",background:"var(--danger)",display:"block",marginTop:1}}/>}
          </button>
        ))}
      </nav>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
